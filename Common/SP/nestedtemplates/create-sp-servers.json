{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "labName": {
            "type": "string",
            "metadata": {
                "description": "Lab Name."
            }
        },
        "domainAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "Domain Administrator username."
            }
        },
        "domainAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Domain Administrator password."
            }
        },
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "AD Domain Name to join VMs."
            }
        },
        "vNetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the virtual network."
            }
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the subnet."
            }
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources such as templates and DSC modules that the script is dependent"
            }
        },
        "_artifactsLocationSasToken": {
            "type": "string",
            "metadata": {
                "description": "Auto-generated token to access _artifactsLocation"
            }
        }
    },
    "variables": {
        "commonID": "[toLower(parameters('labName'))]",
        "nsgName": "[concat(variables('commonID'), '-sp-nsg')]",
        "tweakServersTemplateUri": "[concat(parameters('_artifactsLocation'),'/nestedtemplates/tweak-server.json', parameters('_artifactsLocationSasToken'))]",
        "servers": [
            {
                "name": "WFE1",
                "size": "Standard_D4s_v3",
                "zone": "1",
                "nsg": "[concat(variables('commonID'), '-sp-nsg')]"
            },
            {
                "name": "WFE2",
                "size": "Standard_D4s_v3",
                "zone": "2",
                "nsg": "[concat(variables('commonID'), '-sp-nsg')]"
            },
            {
                "name": "APP1",
                "size": "Standard_D4s_v3",
                "zone": "1",
                "nsg": "[concat(variables('commonID'), '-nsg')]"
            },
            {
                "name": "APP2",
                "size": "Standard_D4s_v3",
                "zone": "2",
                "nsg": "[concat(variables('commonID'), '-nsg')]"
            }
        ]
    },
    "resources": [
        {
            "apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[variables('nsgName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "securityRules": [
                    {
                        "name": "rdp_rule",
                        "properties": {
                            "description": "Allow RDP",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "Internet",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "web_rule",
                        "properties": {
                          "description": "Allow WEB",
                          "protocol": "Tcp",
                          "sourcePortRange": "*",
                          "destinationPortRange": "443",
                          "sourceAddressPrefix": "Internet",
                          "destinationAddressPrefix": "*",
                          "access": "Allow",
                          "priority": 101,
                          "direction": "Inbound"
                        }
                      }
                ]
            }
        },
        {
            "comments": "Create Public IP Address.",
            "apiVersion": "2016-11-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "copy": {
                "name": "pipLoop",
                "count": "[length(variables('servers'))]"
            },
            "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-pip')]",
            "location": "[resourceGroup().location]",
            "zones": [
                "[variables('servers')[copyIndex()].zone]"
            ],
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "dnsSettings": {
                    "domainNameLabel": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]"
                }
            }
        },
        {
            "comments": "Create Network Interface Card.",
            "apiVersion": "2017-10-01",
            "type": "Microsoft.Network/networkInterfaces",
            "copy": {
                "name": "nicLoop",
                "count": "[length(variables('servers'))]"
            },
            "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-nic')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-pip')]"
            ],
            "properties": {
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('servers')[copyIndex()].nsg)]"
                },
                "ipConfigurations": [
                    {
                        "name": "ipConfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses/', concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-pip'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', parameters('vNetName'), parameters('subnetName'))]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "comments": "Create VM",
            "apiVersion": "2017-03-30",
            "type": "Microsoft.Compute/virtualMachines",
            "copy": {
                "name": "vmLoop",
                "count": "[length(variables('servers'))]"
            },
            "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]",
            "zones": [
                "[variables('servers')[copyIndex()].zone]"
            ],
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-nic'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('servers')[copyIndex()].size]"
                },
                "osProfile": {
                    "computerName": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]",
                    "adminUsername": "[parameters('domainAdminUsername')]",
                    "adminPassword": "[parameters('domainAdminPassword')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2016-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), 'datadisk')]",
                            "diskSizeGB": 64,
                            "lun": 0,
                            "createOption": "Empty",
                            "caching": "ReadOnly"
                        }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-nic'))]"
                        }
                    ]
                }
            }
        },
        {
            "comments": "Configure Shutdown schedule",
            "type": "Microsoft.DevTestLab/schedules",
            "apiVersion": "2017-04-26-preview",
            "copy": {
                "name": "shutdownLoop",
                "count": "[length(variables('servers'))]"
            },
            "name": "[concat('shutdown-computevm-', variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]",
            "location": "[resourceGroup().location]",
            "properties": {
                "status": "Enabled",
                "taskType": "ComputeVmShutdownTask",
                "dailyRecurrence": {
                    "time": "19:00"
                },
                "timeZoneId": "Eastern Standard Time",
                "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name)))]",
                "notificationSettings": {
                    "status": "Enabled",
                    "emailRecipient": "rogarret@microsoft.com",
                    "notificationLocale": "en",
                    "timeInMinutes": "15"
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]"
            ]
        },
        {
            "comments": "Join existing domain.",
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "copy": {
                "name": "adJoinLoop",
                "count": "[length(variables('servers'))]"
            },
            "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '/joindomain')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "Name": "[parameters('domainName')]",
                    "OUPath": "",
                    "User": "[concat(parameters('domainAdminUsername'), '@', parameters('domainName'))]",
                    "Restart": "true",
                    "Options": 3
                },
                "protectedSettings": {
                    "Password": "[parameters('domainAdminPassword')]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name), '-tweakServers')]",
            "copy": {
                "name": "tweakServersLoop",
                "count": "[length(variables('servers'))]"
            },
            "apiVersion": "2016-09-01",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name)), 'joindomain')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('tweakServersTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[concat(variables('commonID'), '-', toLower(variables('servers')[copyIndex()].name))]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        }
    ]
}